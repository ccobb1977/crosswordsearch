/*
crosswordsearch.js v0.1.0

crosswordsearch Wordpress plugin
Copyright Claus Colloseus 2014 for RadiJojo.de

This program is free software: Redistribution and use, with or
without modification, are permitted provided that the following
conditions are met:
 * If you redistribute this code, either as source code or in
   minimized, compacted or obfuscated form, you must retain the
   above copyright notice, this list of conditions and the
   following disclaimer.
 * If you modify this code, distributions must not misrepresent
   the origin of those parts of the code that remain unchanged,
   and you must retain the above copyright notice and the following
   disclaimer.
 * If you modify this code, distributions must include a license
   which is compatible to the terms and conditions of this license.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*/
var customSelectElement=angular.module("customSelectElement",[]);customSelectElement.directive("cseOutsideHide",["$document",function(a){return{link:function(b,c){var d=function(a,b){return a[0]===b[0]},e=function(e){var f=angular.element(e.target);do{if(d(f,c))return;f=f.parent()}while(f.length&&!d(a,f));b.$apply("visible = false")};c.on("$destroy",function(){a.unbind("click",e)}),a.bind("click",e)}}}]),customSelectElement.directive("cseSelect",function(){return{restrict:"A",scope:{options:"=cseOptions",model:"=cseModel"},link:function(a){a.select=function(b){a.model=b}},template:'<dt cse-outside-hide ng-init="visible=false"><a href="" ng-click="visible=!visible"><div ng-show="!!(model)" cse-content value="model"></div></a></dt><dd ng-show="visible"><ul><li ng-repeat="opt in options"><a href="" ng-click="select(opt)" cse-content value="opt"></a></li></ul></dd>'}});var app=angular.module("app",["ngSanitize","qantic.angularjs.stylemodel","customSelectElement"]);app.factory("basics",function(){return{colors:["black","red","green","blue","orange","violet","aqua"],pluginPath:crwBasics.pluginPath,randomColor:function(a){var b;do b=this.colors[Math.floor(7*Math.random())];while(b===a);return b},randomLetter:function(){var a="",b=0;angular.forEach(crwBasics.letterDist,function(c,d){b+=c;for(var e=0;c>e;e++)a+=d});var c=Math.floor(Math.random()*b);return a.slice(c,c+1)},letterRegEx:new RegExp(crwBasics.letterRegEx),fieldSize:31,directionMapping:{"down-right":{end:"up-left",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-left":{end:"down-right",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-right":{end:"down-left",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},"down-left":{end:"up-right",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},down:{end:"up",middle:"vertical"},up:{end:"down",middle:"vertical"},right:{end:"left",middle:"horizontal"},left:{end:"right",middle:"horizontal"}},testCrossword:'{"name":"test","size":{"width":10,"height":7},"table":[[{"letter":"V"},{"letter":"N"},{"letter":"N"},{"letter":"C"},{"letter":"G"},{"letter":"L"},{"letter":"D"},{"letter":"S"},{"letter":"E"},{"letter":"Y"}],[{"letter":"M"},{"letter":"E"},{"letter":"R"},{"letter":"K"},{"letter":"U"},{"letter":"R"},{"letter":"N"},{"letter":"A"},{"letter":"M"},{"letter":"E"}],[{"letter":"T"},{"letter":"P"},{"letter":"N"},{"letter":"J"},{"letter":"U"},{"letter":"P"},{"letter":"I"},{"letter":"T"},{"letter":"E"},{"letter":"R"}],[{"letter":"D"},{"letter":"T"},{"letter":"N"},{"letter":"U"},{"letter":"R"},{"letter":"A"},{"letter":"N"},{"letter":"U"},{"letter":"S"},{"letter":"D"}],[{"letter":"W"},{"letter":"U"},{"letter":"D"},{"letter":"S"},{"letter":"S"},{"letter":"E"},{"letter":"B"},{"letter":"R"},{"letter":"F"},{"letter":"E"}],[{"letter":"E"},{"letter":"N"},{"letter":"N"},{"letter":"O"},{"letter":"S"},{"letter":"I"},{"letter":"A"},{"letter":"N"},{"letter":"E"},{"letter":"C"}],[{"letter":"E"},{"letter":"E"},{"letter":"I"},{"letter":"S"},{"letter":"G"},{"letter":"M"},{"letter":"D"},{"letter":"E"},{"letter":"N"},{"letter":"H"}]],"words":{"2":{"id":2,"color":"orange","stop":{"x":0,"y":5},"start":{"x":4,"y":5},"fields":[{"x":4,"y":5,"word":{"letter":"S"}},{"x":3,"y":5,"word":{"letter":"O"}},{"x":2,"y":5,"word":{"letter":"N"}},{"x":1,"y":5,"word":{"letter":"N"}},{"x":0,"y":5,"word":{"letter":"E"}}],"direction":"left"},"3":{"id":3,"color":"violet","stop":{"x":5,"y":1},"start":{"x":0,"y":1},"fields":[{"x":0,"y":1,"word":{"letter":"M"}},{"x":1,"y":1,"word":{"letter":"E"}},{"x":2,"y":1,"word":{"letter":"R"}},{"x":3,"y":1,"word":{"letter":"K"}},{"x":4,"y":1,"word":{"letter":"U"}},{"x":5,"y":1,"word":{"letter":"R"}}],"direction":"right"},"4":{"id":4,"color":"green","stop":{"x":4,"y":4},"start":{"x":0,"y":0},"fields":[{"x":0,"y":0,"word":{"letter":"V"}},{"x":1,"y":1,"word":{"letter":"E"}},{"x":2,"y":2,"word":{"letter":"N"}},{"x":3,"y":3,"word":{"letter":"U"}},{"x":4,"y":4,"word":{"letter":"S"}}],"direction":"down-right"},"5":{"id":5,"color":"aqua","stop":{"x":9,"y":4},"start":{"x":9,"y":1},"fields":[{"x":9,"y":1,"word":{"letter":"E"}},{"x":9,"y":2,"word":{"letter":"R"}},{"x":9,"y":3,"word":{"letter":"D"}},{"x":9,"y":4,"word":{"letter":"E"}}],"direction":"down"},"6":{"id":6,"color":"black","stop":{"x":8,"y":3},"start":{"x":5,"y":6},"fields":[{"x":5,"y":6,"word":{"letter":"M"}},{"x":6,"y":5,"word":{"letter":"A"}},{"x":7,"y":4,"word":{"letter":"R"}},{"x":8,"y":3,"word":{"letter":"S"}}],"direction":"up-right"},"7":{"id":7,"color":"blue","stop":{"x":9,"y":2},"start":{"x":3,"y":2},"fields":[{"x":3,"y":2,"word":{"letter":"J"}},{"x":4,"y":2,"word":{"letter":"U"}},{"x":5,"y":2,"word":{"letter":"P"}},{"x":6,"y":2,"word":{"letter":"I"}},{"x":7,"y":2,"word":{"letter":"T"}},{"x":8,"y":2,"word":{"letter":"E"}},{"x":9,"y":2,"word":{"letter":"R"}}],"direction":"right"},"8":{"id":8,"color":"red","stop":{"x":7,"y":5},"start":{"x":7,"y":0},"fields":[{"x":7,"y":0,"word":{"letter":"S"}},{"x":7,"y":1,"word":{"letter":"A"}},{"x":7,"y":2,"word":{"letter":"T"}},{"x":7,"y":3,"word":{"letter":"U"}},{"x":7,"y":4,"word":{"letter":"R"}},{"x":7,"y":5,"word":{"letter":"N"}}],"direction":"down"},"9":{"id":9,"color":"violet","stop":{"x":8,"y":3},"start":{"x":3,"y":3},"fields":[{"x":3,"y":3,"word":{"letter":"U"}},{"x":4,"y":3,"word":{"letter":"R"}},{"x":5,"y":3,"word":{"letter":"A"}},{"x":6,"y":3,"word":{"letter":"N"}},{"x":7,"y":3,"word":{"letter":"U"}},{"x":8,"y":3,"word":{"letter":"S"}}],"direction":"right"},"10":{"id":10,"color":"aqua","stop":{"x":1,"y":5},"start":{"x":1,"y":0},"fields":[{"x":1,"y":0,"word":{"letter":"N"}},{"x":1,"y":1,"word":{"letter":"E"}},{"x":1,"y":2,"word":{"letter":"P"}},{"x":1,"y":3,"word":{"letter":"T"}},{"x":1,"y":4,"word":{"letter":"U"}},{"x":1,"y":5,"word":{"letter":"N"}}],"direction":"down"}}}'}}),app.factory("immediate",["$q",function(a){var b={};return{register:function(a,c){b[a]||(b[a]=[]),b[a].push(c)},newPromise:function(c,d){var e=a.defer();return b[c]&&angular.forEach(b[c],function(a){a(e,d)}),e.promise}}}]),app.factory("crossword",["basics",function(a){var b={name:"",size:{width:10,height:10},content:[],words:{},solution:{}},c=function(){var a=[];return f(a,b.size.width,!1),a},d=function(){return{letter:null}},e=function(a,d){if(a>0)for(var e=0;a>e;e++)d?b.content.unshift(new c):b.content.push(new c);else b.content.splice(d?0:b.content.length+a,-a);d&&angular.forEach(b.words,function(b){b.start.y+=a,b.stop.y+=a})},f=function(a,b,c){if(b>0)for(var e=0;b>e;e++)c?a.unshift(new d):a.push(new d);else a.splice(c?0:a.length+b,-b)},g=function(a,c){for(var d=0;d<b.content.length;d++)f(b.content[d],a,c);c&&angular.forEach(b.words,function(b){b.start.x+=a,b.stop.x+=a})},h=function(a){angular.forEach(b.content,function(b,c){angular.forEach(b,function(b,d){a.call(b,c,d)})})};return e(b.size.height,!1),{getCrossword:function(){return b},loadCrossword:function(c){var d=angular.fromJson(c||a.testCrossword);b.name=d.name,b.size=d.size,b.words=d.words,b.content=d.table,b.solution={}},setName:function(a){b.name=a},randomColor:function(){var c=0;return angular.forEach(b.words,function(a){a.id>c&&(c=a.id)}),a.randomColor(c>0?b.words[c].color:void 0)},deleteWord:function(a,c){b[c][a]&&delete b[c][a]},randomizeEmptyFields:function(){h(function(){this.letter||(this.letter=a.randomLetter("german"))})},emptyAllFields:function(){h(function(){this.letter=null})},setWord:function(a){return angular.forEach(a.fields,function(a){a.word=b.content[a.y][a.x]}),b.words[a.id]=a},probeWord:function(a){var c=a;return angular.forEach(c.fields,function(a){a.word=b.content[a.y][a.x]}),c.solved=!1,angular.forEach(b.words,function(a){angular.equals(a.start,c.start)&&angular.equals(a.stop,c.stop)&&(c=a,a.solved=!0)}),c.markingId=a.id,b.solution[c.id]=c},testWordBoundaries:function(a){var c=[];return angular.forEach(b.words,function(d,e){(Math.min(d.start.x,d.stop.x)<-a.left||Math.max(d.start.x,d.stop.x)>=b.size.width+a.right||Math.min(d.start.y,d.stop.y)<-a.top||Math.max(d.start.y,d.stop.y)>=b.size.height+a.bottom)&&c.push(parseInt(e,10))}),c},changeSize:function(a,c){angular.forEach(c,function(a){this.deleteWord(a,"words")},this);var d=angular.copy(b.size);0!==a.left&&(g(a.left,!0),d.width+=a.left),0!==a.right&&(g(a.right,!1),d.width+=a.right),0!==a.top&&(e(a.top,!0),d.height+=a.top),0!==a.bottom&&(e(a.bottom,!1),d.height+=a.bottom),b.size=d}}}]),app.factory("markers",["basics",function(a){function b(a,b,c,e){null!=e&&(null==d[b]&&(d[b]={}),null==d[b][c]&&(d[b][c]={}),d[b][c][a.id]={marking:a,img:e})}function c(c,d){var e=a.directionMapping[c.direction];angular.forEach(c.fields,function(a,f){if(0===f){if(b(c,a.x,a.y,c.direction),"origin"===c.direction)return;d?b(c,a.x-1,a.y,e.left):b(c,a.x+1,a.y,e.right)}else f===c.fields.length-1?(b(c,a.x,a.y,e.end),d?b(c,a.x+1,a.y,e.right):b(c,a.x-1,a.y,e.left)):(b(c,a.x,a.y,e.middle),b(c,a.x-1,a.y,e.left),b(c,a.x+1,a.y,e.right))})}var d={};return{setNewMarkers:function(a){var b,d=a.start,e=a.stop,f=e.x-d.x,g=e.y-d.y,h=0>f||0===f&&0>g;if(this.deleteMarking(a.id),a.fields=[],f*g>0)for(a.direction=h?"up-left":"down-right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y+b});else if(0>f*g)for(a.direction=h?"down-left":"up-right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y-b});else if(0===f&&0===g)a.direction="origin",a.fields.push({x:d.x,y:d.y});else if(0===f)for(a.direction=h?"up":"down",b=0;Math.abs(b)<=Math.abs(e.y-d.y);h?b--:b++)a.fields.push({x:d.x,y:d.y+b});else for(a.direction=h?"left":"right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y});c(a,h)},exchangeMarkers:function(a,b,c){angular.forEach(a,function(a){d[a.x][a.y][b].marking.color=c})},shiftMarkers:function(a,b,d){angular.forEach(a,function(a){var e=a.start,f=a.stop,g=f.x<e.x||f.x===e.x&&f.y<e.y;this.deleteMarking(a.id),angular.forEach(a.fields,function(a){a.x+=b,a.y+=d}),c(a,g)},this)},getMarks:function(a,b){return null==d[a]||null==b?void 0:d[a][b]},deleteMarking:function(a){angular.forEach(d,function(b){angular.forEach(b,function(b){delete b[a]})})},deleteAllMarking:function(){d={}}}}]),app.controller("SizeController",["$scope","$document","immediate","crossword","basics","StyleModelContainer",function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o=e.fieldSize,p=function(b,c){i=g=-1,j=b*o+1,h=c*o+1,k=l=0,m=b*o,n=c*o,a.modLeft.transform(i,0),a.modTop.transform(0,g),a.modRight.transform(j,0),a.modBottom.transform(0,h)};a.crw=d.getCrossword(),f.add("size-left",-1/0,(a.crw.size.height-3)*o+1,0,0),f.add("size-top",0,0,-1/0,(a.crw.size.width-3)*o+1),f.add("size-right",5*o+1,1/0,0,0),f.add("size-bottom",0,0,5*o+1,1/0),a.modLeft=f.get("size-left"),a.modTop=f.get("size-top"),a.modRight=f.get("size-right"),a.modBottom=f.get("size-bottom"),p(a.crw.size.width,a.crw.size.height),a.$watch("crw.size",function(a){p(a.width,a.height)}),a.modLeft.addStyle("size-left",function(b){i=b,k=Math.ceil((i+1)/o)*o,m=Math.floor((j-1-k)/o)*o,a.modRight&&(a.modRight.minx=Math.floor((i+1)/o)*o+3*o+1)}),a.modLeft.addStyle("handle-left",function(){return{left:i-k-6+"px",width:k-i+12+"px"}}),a.modTop.addStyle("size-top",function(b,c){g=c,l=Math.ceil((g+1)/o)*o,n=Math.floor((h-1-l)/o)*o,a.modBottom&&(a.modBottom.miny=Math.floor((g+1)/o)*o+3*o+1)}),a.modTop.addStyle("handle-top",function(){return{top:g-l-6+"px",height:l-g+12+"px"}}),a.modRight.addStyle("size-right",function(b){j=b,m=Math.floor((j-1-k)/o)*o,a.modLeft&&(a.modLeft.maxx=Math.floor((j-1)/o)*o-3*o+1)}),a.modRight.addStyle("handle-right",function(){return{right:k+m-j-6+"px",width:j-k-m+12+"px"}}),a.modBottom.addStyle("size-bottom",function(b,c){h=c,n=Math.floor((h-1-l)/o)*o,a.modTop&&(a.modTop.maxy=Math.floor((h-1)/o)*o-3*o+1)}),a.modBottom.addStyle("handle-bottom",function(){return{bottom:l+n-h-6+"px",height:h-l-n+12+"px"}}),a.styleGridSize=function(){return{left:k+"px",width:m+"px",top:l+"px",height:n+"px"}},a.styleShift=function(){return{left:-k+"px",top:-l+"px"}};var q,r=function(){return{left:-k/o,right:(k+m)/o,top:-l/o,bottom:(l+n)/o}};a.startResize=function(){q=r(),b.on("$destroy",b.unbind("mouseup",s)),b.bind("mouseup",s)};var s=function(){var e=r();if(!angular.equals(q,e)){var f={left:e.left-q.left,right:e.right-q.right,top:e.top-q.top,bottom:e.bottom-q.bottom},g=d.testWordBoundaries(f);g.length?c.newPromise("invalidWords",g).then(function(){d.changeSize(f,g)},function(){p(q.right+q.left,q.bottom+q.top)}):a.$apply(d.changeSize(f,g))}b.unbind("mouseup",s)}}]),app.directive("crwSetFocus",function(){return{link:function(a,b){b.on("mousemove",function(a){a.preventDefault()}),a.$on("setFocus",function(c,d,e){d===a.line&&e===a.column&&b[0].focus()})}}}),app.directive("crwCatchDragging",["$document",function(a){return{link:function(b,c){var d=function(c){c.preventDefault(),a.bind("mouseup",e),b.startMark()},e=function(c){c.preventDefault(),a.unbind("mouseup",e),b.$apply(b.stopMark())};c.bind("mousedown",d),a.bind("mouseup",e),c.on("$destroy",function(){a.unbind("mouseup",e)})}}}]),app.directive("crwIndexChecker",function(){return{link:function(a,b,c){a.$watch("$index",function(b){a[c.crwIndexChecker]=b})}}}),app.controller("TableController",["$scope","basics","immediate","crossword","markers",function(a,b,c,d,e){function f(a){var b=g.start.x-a.x,c=g.start.y-a.y;return Math.abs(b)===Math.abs(c)||0===b||0===c}var g,h,i=!1;a.setMode=function(b){if(h=b,"build"===h&&(g={id:0},a.$watch("crw.words",function(b,c){var d,f=0,g=0;angular.forEach(c,function(a,c){b[c]?d=c:e.deleteMarking(c)}),d&&(f=b[d].start.x-c[d].start.x,g=b[d].start.y-c[d].start.y,(0!==f||0!==g)&&e.shiftMarkers(a.crw.words,f,g))},!0)),"solve"===h){var c=function(){var b=0;return angular.forEach(a.crw.words,function(a,c){b=Math.max(b,c)}),b};g={id:c()},a.$watch("crw.solution",function(a,b){angular.forEach(b,function(b,c){a[c]||e.deleteMarking(b.markingId)});var d=!1;angular.forEach(a,function(a,c){b[c]||e.exchangeMarkers(a.fields,g.id,a.color),d=!0}),d||(g.id=c())},!0)}},a.getMarks=function(a,b){return e.getMarks(b,a)},a.getImgClass=function(a){return[a.img,a.marking.color]},a.activate=function(b,c){a.$broadcast("setFocus",b,c)},a.startMark=function(){i=!0,g={id:g.id+1},g.color="build"===h?d.randomColor():"grey"},a.stopMark=function(){if(i=!1,angular.equals(g.start,g.stop))e.deleteMarking(g.id);else if("build"===h)d.setWord(g);else{var a=d.probeWord(g);a.solved||c.newPromise("falseWord",a).then(function(){d.deleteWord(g.id,"solution")})}},a.intoField=function(a,b){var c={x:b,y:a};i&&g.start&&f(c)&&(g.stop=c,e.setNewMarkers(g))},a.outofField=function(a,b){i&&!g.start&&(g.start=g.stop={x:b,y:a},e.setNewMarkers(g))},a.type=function(a){a.preventDefault();var c=a.charCode||a.keyCode||a.which,d=String.fromCharCode(c);if(b.letterRegEx.test(d))this.field.letter=d.toUpperCase();else switch(c){case 8:case 46:this.field.letter=null;break;case 37:this.column>0&&this.activate(this.line,this.column-1);break;case 38:this.line>0&&this.activate(this.line-1,this.column);break;case 39:this.column<this.row.length-1&&this.activate(this.line,this.column+1);break;case 40:this.line<this.crw.content.length-1&&this.activate(this.line+1,this.column)}}}]),app.directive("cseContent",["basics",function(a){return{scope:{value:"="},template:'<img ng-src="'+a.pluginPath+'images/bullet-{{value}}.png">'}}]),app.filter("joinWord",function(){return function(a){var b="";return angular.forEach(a,function(a){b+=a.word.letter||"_"}),b}}),app.directive("crwInvalidWords",function(){return{template:'<p ng-pluralize count="invalidCount" when="{\'one\': \'Das markierte Wort passt nicht mehr vollständig in das Rätselfeld. Um die Größe anzupassen, muss es gelöscht werden.\',\'other\': \'Die markierten Wörter passen nicht mehr vollständig in das Rätselfeld. Um die Größe anzupassen, müssen sie gelöscht werden.\'}"></p><p class="actions"><button ng-click="deleteInvalid()">Löschen</button> <button ng-click="abortInvalid()">Abbrechen</button></p>'}}),app.directive("crwSaveCrossword",function(){return{template:'<form name="uploader"><p>Zum Speichern muss das Rätsel einen Namen erhalten (mindestens 4 Buchstaben):</p><p class="actions"><input type="text" ng-model="crw.name" name="name" required="" ng-minlength="4"> <button ng-disabled="!uploader.name.$valid" ng-click="upload()">Speichern</button></p><p class="error" ng-show="uploader.name.$error.required">Ein Name muss angegeben werden!</p><p class="error" ng-show="uploader.name.$error.minlength">Der Name ist zu kurz!</p><p class="confirm" ng-show="uploader.name.$valid">So geht\'s!</p></form>'}}),app.directive("crwFalseWord",function(){return{template:'<p>Das markierte Wort ist kein Teil der Lösung.</p><p class="actions"><button ng-click="deleteFalse()">Löschen</button></p>'}}),app.controller("EntryController",["$scope","$filter","crossword","basics",function(a,b,c,d){a.colors=d.colors,a.deleteWord=function(a){c.deleteWord(a,"words")}}]),app.controller("WordController",["$scope","$sanitize","crossword","immediate",function(a,b,c,d){var e,f=[];a.crw=c.getCrossword(),a.wordsToArray=function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b},a.randomize=function(){c.randomizeEmptyFields()},a.empty=function(){c.emptyAllFields()},a.load=function(){c.loadCrossword(),a.crw=c.getCrossword()},a.save=function(){d.newPromise("saveCrossword").then(function(){a.crw.name=b(a.crw.name)},angular.noop)},a.isHighlighted=function(a){for(var b=0;b<f.length;b++)if(f[b]===a)return!0;return!1},d.register("invalidWords",function(b,c){e=b,f=c,a.invalidCount=c.length,a.immediate="invalidWords"}),a.deleteInvalid=function(){a.immediate=null,e.resolve(),f=[]},a.abortInvalid=function(){a.immediate=null,f=[],e.reject()},d.register("falseWord",function(b,c){e=b,f=[c.id],a.immediate="falseWord"}),a.deleteFalse=function(){a.immediate=null,e.resolve(),f=[]},d.register("saveCrossword",function(b){e=b,a.immediate="saveCrossword"}),a.upload=function(){a.immediate=null,e.resolve()}}]);