/*
crosswordsearch.js v0.1.0

crosswordsearch Wordpress plugin
Copyright Claus Colloseus 2014 for RadiJojo.de

This program is free software: Redistribution and use, with or
without modification, are permitted provided that the following
conditions are met:
 * If you redistribute this code, either as source code or in
   minimized, compacted or obfuscated form, you must retain the
   above copyright notice, this list of conditions and the
   following disclaimer.
 * If you modify this code, distributions must not misrepresent
   the origin of those parts of the code that remain unchanged,
   and you must retain the above copyright notice and the following
   disclaimer.
 * If you modify this code, distributions must include a license
   which is compatible to the terms and conditions of this license.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*/
var customSelectElement=angular.module("customSelectElement",[]);customSelectElement.directive("cseDefault",["$compile",function(){return{scope:{value:"="},template:"{{value.value || value}}"}}]),customSelectElement.directive("cseOption",["$compile",function(a){return{scope:{value:"=",isMenu:"=",templ:"="},link:function(b,c,d){b.select=function(a){b.$emit("select",a)},d.$observe("value",function(){var e;angular.isObject(b.value)&&b.value.group?(e='<dl class="cse text" cse-select cse-options="value.group" cse-model="head" cse-template="'+d.templ+'"',angular.isDefined(b.isMenu)&&(e+=' cse-is-menu ng-init="head=value"'),e+="></dl>",c.html(e)):(e="<div ng-click=",e+=angular.isObject(b.value)&&angular.isDefined(b.value.value)?'"select(value.value)" ':'"select(value)" ',e+=d.templ+' value="value"></div>',c.html(e)),a(c.contents())(b)})}}}]),customSelectElement.directive("cseSelect",["$document",function(a){return{restrict:"A",scope:{options:"=cseOptions",model:"=cseModel",isMenu:"=cseIsMenu",cseTemplate:"="},link:function(b,c,d){b.setModel=!angular.isDefined(d.cseIsMenu);var e=function(a,b){return a[0]===b[0]},f=function(d){var f=angular.element(d.target);do{if(e(f,c))return;f=f.parent()}while(f.length&&!e(a,f));b.$apply("visible = false")};b.visible=!1,b.$watch("visible",function(b){b?a.bind("click",f):a.unbind("click",f)}),c.on("$destroy",function(){a.unbind("click",f)}),b.$on("select",function(a,c){b.visible=!1,b.setModel&&(b.model=c)})},template:function(a,b){var c=b.cseTemplate||"cse-default",d='<dt ng-click="visible=!visible"><div ng-show="!!(model)" '+c+' value="model"></div></dt><dd ng-show="visible"><ul><li ng-repeat="opt in options | orderBy:\'order\'" cse-option value="opt" templ="'+c+'"';return angular.isDefined(b.cseIsMenu)&&(d+=' is-menu="1"'),d+="></li></ul></dd>"}}}]);var crwApp=angular.module("crwApp",["ngSanitize","qantic.angularjs.stylemodel","customSelectElement"]);crwApp.factory("reduce",function(){return function(a,b,c){return angular.forEach(a,function(a,d){b=c.apply(a,[b,a,d])}),b}}),crwApp.factory("basics",["reduce",function(a){var b=0,c=a(crwBasics.letterDist,"",function(a,c,d){b+=c;for(var e=0;c>e;e++)a+=d;return a});return{colors:["black","red","green","blue","orange","violet","aqua"],pluginPath:crwBasics.pluginPath,randomColor:function(a){var b;do b=this.colors[Math.floor(7*Math.random())];while(b===a);return b},randomLetter:function(){var a=Math.floor(Math.random()*b);return c.slice(a,a+1)},letterRegEx:new RegExp(crwBasics.letterRegEx),fieldSize:31,directionMapping:{"down-right":{end:"up-left",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-left":{end:"down-right",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-right":{end:"down-left",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},"down-left":{end:"up-right",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},down:{end:"up",middle:"vertical"},up:{end:"down",middle:"vertical"},right:{end:"left",middle:"horizontal"},left:{end:"right",middle:"horizontal"}},localize:function(a){return crwBasics.locale[a]||a}}}]),crwApp.factory("crosswordFactory",["$http","$q","basics","reduce",function(a,b,c,d){function e(){var e={},g=[],h="",i="",j=function(a,b){if(a>0)for(var c=0;a>c;c++){var d=[];k(d,e.size.width,!1),b?e.table.unshift(d):e.table.push(d)}else e.table.splice(b?0:e.table.length+a,-a);b&&angular.forEach(e.words,function(b){b.start.y+=a,b.stop.y+=a})},k=function(a,b,c){if(b>0)for(var d=0;b>d;d++){var e={letter:null};c?a.unshift(e):a.push(e)}else a.splice(c?0:a.length+b,-b)},l=function(a,b){for(var c=0;c<e.table.length;c++)k(e.table[c],a,b);b&&angular.forEach(e.words,function(b){b.start.x+=a,b.stop.x+=a})},m=function(a){angular.forEach(e.table,function(b,c){angular.forEach(b,function(b,d){a.call(b,c,d)})})};this.getCrosswordData=function(){return e},this.getNamesList=function(){return g};var n=function(a){return b.reject({error:"server error",debug:"status "+a.status})},o=function(a){return"object"!=typeof a.data?{error:"malformed request"}:a.data.error?a.data:!1};this.setProject=function(a,b){h=a,i=b},this.loadDefault=function(){angular.extend(e,{name:"",size:{width:10,height:10},table:[],words:{},solution:{}}),j(e.size.height,!1)},this.loadCrosswordData=function(c){return a(angular.extend({data:{action:"get_crossword",project:h,name:c}},f)).then(function(a){var c=o(a);return c?b.reject(c):(angular.extend(e,a.data.crossword),g=a.data.namesList,i=a.data.nonce,!0)},n)},this.saveCrosswordData=function(c,d,j,k){var l={action:d+"_crossword",project:h,crossword:angular.toJson(e),username:j,password:k,_crwnonce:i};return"update"===d?(l.old_name=c,l.name=e.name):l.name=c,a(angular.extend({data:l},f)).then(function(a){var c=o(a);return c?b.reject(c):(g=a.data.namesList,!0)},n)},this.setName=function(a){e.name=a},this.getHighId=function(){return d(e.words,0,function(a,b){return Math.max(a,b.ID)})},this.randomColor=function(){var a=this.getHighId();return c.randomColor(a>0?e.words[a].color:void 0)},this.deleteWord=function(a,b){e[b][a]&&delete e[b][a]},this.randomizeEmptyFields=function(){m(function(){this.letter||(this.letter=c.randomLetter("german"))})},this.emptyAllFields=function(){m(function(){this.letter=null})},this.setWord=function(a){return angular.forEach(a.fields,function(a){a.word=e.table[a.y][a.x]}),e.words[a.ID]=a},this.probeWord=function(a){var b=a;return angular.forEach(b.fields,function(a){a.word=e.table[a.y][a.x]}),b.solved=!1,angular.forEach(e.words,function(a){angular.equals(a.start,b.start)&&angular.equals(a.stop,b.stop)&&(b=a,a.solved=!0)}),b.markingId=a.ID,e.solution[b.ID]=b},this.testWordBoundaries=function(a){var b=[];return angular.forEach(e.words,function(c,d){(Math.min(c.start.x,c.stop.x)<-a.left||Math.max(c.start.x,c.stop.x)>=e.size.width+a.right||Math.min(c.start.y,c.stop.y)<-a.top||Math.max(c.start.y,c.stop.y)>=e.size.height+a.bottom)&&b.push(parseInt(d,10))}),b},this.changeSize=function(a,b){angular.forEach(b,function(a){this.deleteWord(a,"words")},this);var c=angular.copy(e.size);0!==a.left&&(l(a.left,!0),c.width+=a.left),0!==a.right&&(l(a.right,!1),c.width+=a.right),0!==a.top&&(j(a.top,!0),c.height+=a.top),0!==a.bottom&&(j(a.bottom,!1),c.height+=a.bottom),e.size=c}}a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",a.defaults.transformRequest=jQuery.param;var f={method:"POST",url:crwBasics.ajaxUrl};return{getCrw:function(){return new e}}}]),crwApp.factory("markerFactory",["basics",function(a){function b(){function b(a,b,c,e){null!=e&&(null==d[b]&&(d[b]={}),null==d[b][c]&&(d[b][c]={}),d[b][c][a.ID]={marking:a,img:e})}function c(c,d){var e=a.directionMapping[c.direction];angular.forEach(c.fields,function(a,f){if(0===f){if(b(c,a.x,a.y,c.direction),"origin"===c.direction)return;d?b(c,a.x-1,a.y,e.left):b(c,a.x+1,a.y,e.right)}else f===c.fields.length-1?(b(c,a.x,a.y,e.end),d?b(c,a.x+1,a.y,e.right):b(c,a.x-1,a.y,e.left)):(b(c,a.x,a.y,e.middle),b(c,a.x-1,a.y,e.left),b(c,a.x+1,a.y,e.right))})}var d={};this.setNewMarkers=function(a){var b,d=a.start,e=a.stop,f=e.x-d.x,g=e.y-d.y,h=0>f||0===f&&0>g;if(this.deleteMarking(a.ID),a.fields=[],f*g>0)for(a.direction=h?"up-left":"down-right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y+b});else if(0>f*g)for(a.direction=h?"down-left":"up-right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y-b});else if(0===f&&0===g)a.direction="origin",a.fields.push({x:d.x,y:d.y});else if(0===f)for(a.direction=h?"up":"down",b=0;Math.abs(b)<=Math.abs(e.y-d.y);h?b--:b++)a.fields.push({x:d.x,y:d.y+b});else for(a.direction=h?"left":"right",b=0;Math.abs(b)<=Math.abs(e.x-d.x);h?b--:b++)a.fields.push({x:d.x+b,y:d.y});c(a,h)},this.exchangeMarkers=function(a,b,c){angular.forEach(a,function(a){d[a.x][a.y][b].marking.color=c})},this.redrawMarkers=function(a,b,d){angular.forEach(a,function(a){var e=a.start,f=a.stop,g=f.x<e.x||f.x===e.x&&f.y<e.y;this.deleteMarking(a.ID),angular.forEach(a.fields,function(a){a.x+=b||0,a.y+=d||0}),c(a,g)},this)},this.getMarks=function(a,b){return null==d[a]||null==b?void 0:d[a][b]},this.deleteMarking=function(a){angular.forEach(d,function(b){angular.forEach(b,function(b){delete b[a]})})},this.deleteAllMarking=function(){d={}}}return{getMarkers:function(){return new b}}}]),crwApp.directive("crwCatchMouse",["$document",function(a){return{link:function(b,c,d){var e=function(c){angular.isDefined(d.preventDefault)&&c.preventDefault(),a.bind("mouseup",f),b[d.down]()},f=function(c){angular.isDefined(d.preventDefault)&&c.preventDefault(),a.unbind("mouseup",f),b.$apply(b[d.up]())};c.bind("mousedown",e),c.on("$destroy",function(){c.unbind("mousedown",e),a.unbind("mouseup",f)})}}}]),crwApp.directive("crwMenu",["$compile",function(){return{scope:{value:"="},link:function(a,b){a.$watch("value",function(){b.attr("title",a.value.title)})},template:"{{value.display || value}}"}}]),crwApp.controller("CrosswordController",["$scope","qStore","basics","crosswordFactory",function(a,b,c,d){function e(b){jQuery.grep(a.commandList,function(a){return"load"===a.value})[0].group=b}a.crw=d.getCrw(),a.immediateStore=b.addStore(),a.highlight=[],a.count={words:0,solution:0},a.commands={"new":"load()",load:"group",update:'save("update")',insert:'save("insert")',reload:"load(loadedName)"},a.commandList=jQuery.map(a.commands,function(a,b){var d=c.localize(b);return d.value=b,"load"===b&&(d.group=[]),d}),a.$on("select",function(b,c){var d;d=a.namesInProject.indexOf(c)<0?a.commands[c]:'load("'+c+'")',a.$evalAsync(d)}),a.prepare=function(b,c,d){a.crw.setProject(b,c);var e=a.$on("immediateReady",function(){a.load(d),e()})},a.wordsToArray=function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b};var f=function(a){var b=0;return angular.forEach(a,function(){b++}),b},g=function(){a.crosswordData=a.crw.getCrosswordData(),a.namesInProject=a.crw.getNamesList(),e(a.namesInProject),a.loadedName=a.crosswordData.name,a.count.words=f(a.crosswordData.words),a.count.solution=0};a.setHighlight=function(b){a.highlight=b},a.load=function(b){a.loadError=null,b?a.immediateStore.newPromise("loadCrossword",b).then(g,function(b){a.loadError=b}):(a.crw.loadDefault(),g())},a.restart=function(){a.crosswordData.solution={},a.count.solution=0},a.$watch("count.solution",function(b){b>0&&b===a.count.words&&a.immediateStore.newPromise("solvedCompletely")}),a.save=function(b){a.crosswordData.name||(b="insert"),a.immediateStore.newPromise("saveCrossword",b).then(function(){a.namesInProject=a.crw.getNamesList(),e(a.namesInProject),a.loadedName=a.crosswordData.name})},a.randomize=function(){a.crw.randomizeEmptyFields()},a.empty=function(){a.crw.emptyAllFields()}}]),crwApp.controller("SizeController",["$scope","$document","basics","StyleModelContainer",function(a,b,c,d){var e,f,g,h,i,j,k,l,m=c.fieldSize,n=function(b,c){g=e=-1,h=b*m+1,f=c*m+1,i=j=0,k=b*m,l=c*m,a.modLeft.transform(g,0),a.modTop.transform(0,e),a.modRight.transform(h,0),a.modBottom.transform(0,f)};d.add("size-left",-1/0,(a.crosswordData.size.height-3)*m+1,0,0),d.add("size-top",0,0,-1/0,(a.crosswordData.size.width-3)*m+1),d.add("size-right",5*m+1,1/0,0,0),d.add("size-bottom",0,0,5*m+1,1/0),a.modLeft=d.get("size-left"),a.modTop=d.get("size-top"),a.modRight=d.get("size-right"),a.modBottom=d.get("size-bottom"),n(a.crosswordData.size.width,a.crosswordData.size.height),a.$watch("crosswordData.size",function(a){n(a.width,a.height)}),a.modLeft.addStyle("size-left",function(b){g=b,i=Math.ceil((g+1)/m)*m,k=Math.floor((h-1-i)/m)*m,a.modRight&&(a.modRight.minx=Math.floor((g+1)/m)*m+3*m+1)}),a.modLeft.addStyle("handle-left",function(){return{left:g-i-6+"px",width:i-g+12+"px"}}),a.modTop.addStyle("size-top",function(b,c){e=c,j=Math.ceil((e+1)/m)*m,l=Math.floor((f-1-j)/m)*m,a.modBottom&&(a.modBottom.miny=Math.floor((e+1)/m)*m+3*m+1)}),a.modTop.addStyle("handle-top",function(){return{top:e-j-6+"px",height:j-e+12+"px"}}),a.modRight.addStyle("size-right",function(b){h=b,k=Math.floor((h-1-i)/m)*m,a.modLeft&&(a.modLeft.maxx=Math.floor((h-1)/m)*m-3*m+1)}),a.modRight.addStyle("handle-right",function(){return{right:i+k-h-6+"px",width:h-i-k+12+"px"}}),a.modBottom.addStyle("size-bottom",function(b,c){f=c,l=Math.floor((f-1-j)/m)*m,a.modTop&&(a.modTop.maxy=Math.floor((f-1)/m)*m-3*m+1)}),a.modBottom.addStyle("handle-bottom",function(){return{bottom:j+l-f-6+"px",height:f-j-l+12+"px"}}),a.styleGridSize=function(){return{left:i+"px",width:k+"px",top:j+"px",height:l+"px"}},a.styleShift=function(){return{left:-i+"px",top:-j+"px"}};var o,p=function(){return{left:-i/m,right:(i+k)/m,top:-j/m,bottom:(j+l)/m}};a.startResize=function(){o=p()},a.stopResize=function(){var b=p();if(!angular.equals(o,b)){var c={left:b.left-o.left,right:b.right-o.right,top:b.top-o.top,bottom:b.bottom-o.bottom},d=a.crw.testWordBoundaries(c);d.length?a.immediateStore.newPromise("invalidWords",d).then(function(){a.crw.changeSize(c,d)},function(){n(o.right+o.left,o.bottom+o.top)}):a.crw.changeSize(c,d)}}}]),crwApp.directive("crwSetFocus",function(){return{link:function(a,b){b.on("mousemove",function(a){a.preventDefault()}),a.$on("setFocus",function(c,d,e){d===a.line&&e===a.column&&b[0].focus()})}}}),crwApp.directive("crwIndexChecker",function(){return{link:function(a,b,c){a.$watch("$index",function(b){a[c.crwIndexChecker]=b})}}}),crwApp.controller("TableController",["$scope","basics","markerFactory",function(a,b,c){function d(a){var b=e.start.x-a.x,c=e.start.y-a.y;return Math.abs(b)===Math.abs(c)||0===b||0===c}var e,f,g,h=!1,i=c.getMarkers();a.setMode=function(b){f=b,e={ID:a.crw.getHighId()},"build"===f&&(i.redrawMarkers(a.crosswordData.words),g=a.crosswordData.name,a.$watch("crosswordData.words",function(b,c){var d,f=0,h=0;a.crosswordData.name!==g?(i.deleteAllMarking(),i.redrawMarkers(b),e={ID:a.crw.getHighId()},g=a.crosswordData.name):(angular.forEach(c,function(a,c){b[c]?d=c:i.deleteMarking(c)}),d&&(f=b[d].start.x-c[d].start.x,h=b[d].start.y-c[d].start.y,(0!==f||0!==h)&&i.redrawMarkers(a.crosswordData.words,f,h)))},!0)),"solve"===f&&a.$watch("crosswordData.solution",function(b,c){angular.forEach(c,function(a,c){b[c]||i.deleteMarking(a.markingId)});var d=!1;angular.forEach(b,function(a,b){c[b]||i.exchangeMarkers(a.fields,e.ID,a.color),d=!0}),d||(e.ID=a.crw.getHighId())},!0)},a.getMarks=function(a,b){return i.getMarks(b,a)},a.getImgClass=function(a){return[a.img,a.marking.color]},a.activate=function(b,c){a.$broadcast("setFocus",b,c)},a.startMark=function(){h=!0,e={ID:e.ID+1},e.color="build"===f?a.crw.randomColor():"grey"},a.stopMark=function(){if(h)if(h=!1,angular.equals(e.start,e.stop))i.deleteMarking(e.ID);else if("build"===f)a.crw.setWord(e);else{var b=a.crw.probeWord(e);b.solved?a.count.solution++:a.immediateStore.newPromise("falseWord",b).then(function(){a.crw.deleteWord(e.ID,"solution")})}},a.intoField=function(a,b){var c={x:b,y:a};h&&e.start&&d(c)&&(e.stop=c,i.setNewMarkers(e))},a.outofField=function(a,b){h&&!e.start&&(e.start=e.stop={x:b,y:a},i.setNewMarkers(e))},a.type=function(a){a.preventDefault();var c=a.charCode||a.keyCode||a.which,d=String.fromCharCode(c);if(b.letterRegEx.test(d))this.field.letter=d.toUpperCase();else switch(c){case 8:case 46:this.field.letter=null;break;case 37:this.column>0&&this.activate(this.line,this.column-1);break;case 38:this.line>0&&this.activate(this.line-1,this.column);break;case 39:this.column<this.row.length-1&&this.activate(this.line,this.column+1);break;case 40:this.line<this.crosswordData.table.length-1&&this.activate(this.line+1,this.column)}}}]),crwApp.directive("colorSelect",["basics",function(a){return{scope:{value:"="},template:'<img ng-src="'+a.pluginPath+'images/bullet-{{value}}.png">'}}]),crwApp.filter("joinWord",["reduce",function(a){return function(b){return a(b,"",function(a,b){return a+(b.word.letter||"_")})}}]),crwApp.controller("EntryController",["$scope","$filter","basics",function(a,b,c){a.colors=c.colors,a.isHighlighted=function(){for(var b=0;b<a.highlight.length;b++)if(a.highlight[b]===a.word.ID)return!0;return!1},a.deleteWord=function(b){a.crw.deleteWord(b,"words")},a.localizeDirection=c.localize,a.$on("select",function(a){a.stopPropagation()})}]),crwApp.factory("qStore",["$q",function(a){function b(){var b={};this.register=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},this.newPromise=function(c,d){var e=a.defer();return b[c]&&angular.forEach(b[c],function(a){a(e,d)}),e.promise}}return{addStore:function(){return new b}}}]),crwApp.directive("crwAddParsers",["$sanitize",function(a){return{require:"ngModel",link:function(b,c,d,e){var f=/\s+/,g=d.crwAddParsers.split(f);g.indexOf("unique")>=0&&e.$parsers.unshift(function(a){return b.namesInProject.indexOf(a)<0&&!b.commands.hasOwnProperty(a)?(e.$setValidity("unique",!0),a):void e.$setValidity("unique",!1)}),g.indexOf("sane")>=0&&e.$parsers.unshift(function(b){b=b.replace(f," ");var c=b.replace(/<|%[a-f0-9]{2}/,"");return c=a(c),c===b?(e.$setValidity("sane",!0),b):void e.$setValidity("sane",!1)})}}}]),crwApp.controller("ImmediateController",["$scope",function(a){var b;a.immediate=null,a.finish=function(c){a.setHighlight([]),a.saveError=void 0,a.saveDebug=void 0,a.immediate=null,c?b.resolve():b.reject()},a.immediateStore.register("loadCrossword",function(c,d){b=c,a.immediate="loadCrossword",a.crw.loadCrosswordData(d).then(a.finish,function(c){a.immediate=null,b.reject(c)})}),a.immediateStore.register("invalidWords",function(c,d){b=c,a.setHighlight(d),a.invalidCount=d.length,a.immediate="invalidWords"}),a.immediateStore.register("saveCrossword",function(c,d){b=c,a.immediate="saveCrossword",a.action=d}),a.upload=function(b,c){a.crw.saveCrosswordData("update"===a.action?a.loadedName:a.crosswordData.name,a.loadedName===a.crosswordData.name?"update":a.action,b,c).then(a.finish,function(b){a.saveError=b.error,a.saveDebug=b.debug})},a.immediateStore.register("falseWord",function(c,d){b=c,a.setHighlight([d.ID]),a.immediate="falseWord"}),a.immediateStore.register("solvedCompletely",function(c){b=c,a.immediate="solvedCompletely"}),a.$emit("immediateReady")}]);